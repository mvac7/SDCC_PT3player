/* =============================================================================
  Test PT3 player Library for SDCC
  Version: 1.7 (16/04/2021)
  Author: (test program) mvac7 <mvac7303b@gmail.com>
  Architecture: MSX
  Format: ROM 16K
  Programming language: C and Z80 assembler
   
  Description:

    
  History of versions:
    - 1.7 (16/04/2021) SC1 Tileset + Test Player_IsEnd() + show PT3state
    - 1.6 (15/02/2021) Adaptation to PT3_Player v1.1.6 (function names)
    - 1.5 (28/01/2021) support for multiple songs
    - 1.4 (07/01/2021)
    - 1.3 (06/01/2021) Test PT3_Loop
    - 1.2 (05/01/2021) Updates related to v1.3 of the PT3player Lib
    - 1.1 (04/01/2021) assigning the frequency table to NoteTable
    - 1.0 (28/5/2019)
============================================================================= */

#include "../include/newTypes.h"
#include "../include/msxSystemVariables.h"
#include "../include/msxBIOS.h"

#include "../include/interrupt.h"
#include "../include/memory.h"
#include "../include/keyboard.h"
#include "../include/textmode.h"
#include "../include/unRLEWBtoVRAM.h"

#include "../include/PT3player.h"
#include "../include/PT3player_NoteTable2.h"

//song-data .PT3
#include "../include/maki_ru50inv_PT3.h"
#include "../include/maki_CompoAY19v2_PT3.h"




// -----------------------------------------------------------------------------
#define  HALT __asm halt __endasm   //Z80 instruction: wait for the next interrupt


#define BASE13 0x1B00 // base 13 sprite attribute table
#define BASE14 0x3800 // base 14 sprite pattern table

#define VDPVRAM   0x98 //VRAM Data (Read/Write)
#define VDPSTATUS 0x99 //VDP Status Registers

 
// VRAM address tables screen 1 TXT32
#define BASE5 0x1800 // base 5 name table
#define BASE6 0x2000 // base 6 color table
#define BASE7 0x0000 // base 7 character pattern table
#define BASE8 0x1B00 // base 8 sprite attribute table
#define BASE9 0x3800 // base 9 sprite pattern table 






// Function Declarations -------------------------------------------------------
void SetSpritesSize(char size);

void VPOKE(unsigned int vaddr, char value);
//char VPEEK(uint address);

void WAIT(uint cicles);

void ShowState(uint vaddr, boolean state);

void ShowVumeter(char channel, char value);

void SetSPRITES();

void Pause();

void PlaySong(char songNumber);

void SwapLoop();
void ShowLoop();
void ShowPlayback();
void ShowENDsong();


void PrintF(char* text, char length);



// constants  ------------------------------------------------------------------
const char text01[] = "Test PT3player v1.2 Lib";
const char text02[] = "v1.6 (15/02/2021)";

const char presskey[] = "Press a key to Play";


// Project: mvac7_tileset_GUI_05
// tileset pattern
// Tiles range: 0 to 255
// RLE WB compressed - Original size= 2048 - Compress size= 1036
const char SC1_TSET[]={
0x80,0x08,0x00,0x70,0x7E,0x80,0x02,0x42,0x7E,0x00,0x78,0x4C,0x4E,0x80,0x02,0x42,
0x7E,0x00,0x80,0x02,0x7F,0x41,0x80,0x02,0x7F,0x00,0x7F,0x77,0x77,0x41,0x77,0x77,
0x7F,0x00,0x80,0x02,0x7F,0x41,0x63,0x77,0x7F,0x7F,0x5C,0x62,0x70,0x5E,0x42,0x42,
0x7E,0x00,0xFC,0xBA,0xBA,0x80,0x02,0x82,0xFE,0x80,0x02,0x00,0x18,0x3C,0x7E,0x80,
0x05,0x00,0x7E,0x3C,0x18,0x80,0x02,0x00,0x08,0x18,0x38,0x38,0x18,0x08,0x00,0x00,
0x10,0x18,0x1C,0x1C,0x18,0x10,0x80,0x20,0x00,0x80,0x02,0x18,0x7E,0x80,0x06,0x18,
0xFF,0xFF,0x80,0x05,0x00,0xFF,0xFF,0x80,0x05,0x18,0xF8,0xF8,0x80,0x05,0x18,0x1F,
0x1F,0x80,0x05,0x18,0xFF,0xFF,0x80,0x0A,0x18,0x80,0x02,0x00,0xFF,0xFF,0x80,0x05,
0x00,0x0F,0x1F,0x1C,0x18,0x18,0x80,0x02,0x00,0xF0,0xF8,0x38,0x80,0x03,0x18,0x1C,
0x1F,0x0F,0x80,0x02,0x00,0x18,0x18,0x38,0xF8,0xF0,0x80,0x02,0x00,0xFF,0xDD,0xEB,
0xF7,0xEB,0xDD,0xFF,0xFF,0x80,0x10,0x00,0x10,0x10,0xFF,0xFF,0x10,0x10,0x80,0x08,
0x00,0x80,0x03,0x30,0x00,0x30,0x30,0x00,0x28,0x28,0x80,0x07,0x00,0x28,0x7C,0x28,
0x7C,0x28,0x00,0x00,0x10,0x7C,0xD0,0x7C,0x16,0x7C,0x10,0x00,0x00,0x66,0x6C,0x18,
0x36,0x66,0x00,0x00,0x70,0xD8,0x7A,0xCC,0xCC,0x7A,0x00,0x00,0x18,0x30,0x80,0x04,
0x00,0x18,0x30,0x80,0x02,0x60,0x30,0x18,0x00,0x60,0x30,0x80,0x02,0x18,0x30,0x60,
0x80,0x02,0x00,0x5A,0x3C,0x7E,0x3C,0x5A,0x80,0x02,0x00,0x18,0x18,0x7E,0x18,0x18,
0x80,0x05,0x00,0x30,0x30,0x20,0x80,0x03,0x00,0x7C,0x80,0x07,0x00,0x30,0x30,0x00,
0x00,0x06,0x0C,0x18,0x30,0x60,0xC0,0x00,0x7C,0xC6,0xCE,0xD6,0xE6,0xC6,0x7C,0x00,
0x30,0x70,0x80,0x03,0x30,0x78,0x00,0xFC,0x06,0x06,0x7C,0xC0,0xC0,0xFE,0x00,0xFC,
0x06,0x06,0x7C,0x06,0x06,0xFC,0x00,0x80,0x02,0xC6,0xFE,0x80,0x02,0x06,0x00,0xFE,
0xC0,0xC0,0xFC,0x06,0x06,0xFC,0x00,0x7C,0xC0,0xC0,0xFC,0xC6,0xC6,0x7C,0x00,0xFE,
0x06,0x0C,0x18,0x80,0x02,0x30,0x00,0x7C,0xC6,0xC6,0x7C,0xC6,0xC6,0x7C,0x00,0x7C,
0xC6,0xC6,0x7E,0x06,0x06,0x7C,0x00,0x00,0x30,0x30,0x00,0x30,0x30,0x80,0x02,0x00,
0x30,0x30,0x00,0x30,0x30,0x20,0x00,0x00,0x18,0x30,0x60,0x30,0x18,0x80,0x03,0x00,
0x78,0x00,0x78,0x80,0x03,0x00,0x60,0x30,0x18,0x30,0x60,0x00,0x00,0x3C,0x66,0x06,
0x0C,0x18,0x00,0x18,0x00,0x7C,0x82,0xBA,0xAA,0xBE,0x80,0x00,0x7C,0x00,0x7C,0x80,
0x02,0xC6,0xFE,0xC6,0xC6,0x00,0xFC,0xC6,0xC6,0xFC,0xC6,0xC6,0xFC,0x00,0x7E,0x80,
0x04,0xC0,0x7E,0x00,0xFC,0x80,0x04,0xC6,0xFC,0x00,0xFE,0xC0,0xC0,0xF8,0xC0,0xC0,
0xFE,0x00,0xFE,0xC0,0xC0,0xFC,0x80,0x02,0xC0,0x00,0x7E,0xC0,0xC0,0xCE,0xC6,0xC6,
0x7E,0x00,0x80,0x02,0xC6,0xFE,0x80,0x02,0xC6,0x00,0x78,0x80,0x04,0x30,0x78,0x00,
0x3C,0x80,0x03,0x18,0xD8,0x70,0x00,0xC6,0xC6,0xCC,0xF8,0xCC,0xC6,0xC6,0x00,0x80,
0x05,0xC0,0xFE,0x00,0xC6,0xEE,0xFE,0xD6,0x80,0x02,0xC6,0x00,0xC6,0xE6,0xF6,0xDE,
0xCE,0xC6,0xC6,0x00,0x7C,0x80,0x04,0xC6,0x7C,0x00,0xFC,0x80,0x02,0xC6,0xFC,0xC0,
0xC0,0x00,0x7C,0x80,0x02,0xC6,0xD6,0xCC,0x7A,0x00,0xFC,0xC6,0xC6,0xFC,0x80,0x02,
0xC6,0x00,0x7E,0xC0,0xC0,0x7C,0x06,0x06,0xFC,0x00,0xFC,0x80,0x05,0x30,0x00,0x80,
0x05,0xC6,0x7C,0x00,0x80,0x04,0xC6,0x6C,0x38,0x00,0x80,0x02,0xC6,0xD6,0xFE,0xEE,
0xC6,0x00,0xC6,0xC6,0x6C,0x38,0x6C,0xC6,0xC6,0x00,0x80,0x02,0xCC,0x78,0x80,0x02,
0x30,0x00,0xFE,0x06,0x0C,0x18,0x30,0x60,0xFE,0x00,0x0E,0x80,0x04,0x0C,0x0E,0x00,
0x00,0xC0,0x60,0x30,0x18,0x0C,0x06,0x00,0x38,0x80,0x04,0x18,0x38,0x80,0x0E,0x00,
0x7E,0x80,0x0A,0x00,0xFC,0x06,0x7E,0xC6,0xFE,0x00,0xC0,0xC0,0xFC,0x80,0x02,0xC6,
0xFC,0x80,0x02,0x00,0x7E,0x80,0x02,0xC0,0x7E,0x00,0x06,0x06,0x7E,0x80,0x02,0xC6,
0x7E,0x80,0x02,0x00,0x7C,0xC6,0xFE,0xC0,0x7C,0x00,0x3C,0x60,0x60,0xF8,0x80,0x02,
0x60,0x80,0x02,0x00,0x7E,0xC6,0xC6,0x7E,0x06,0x7C,0xC0,0xC0,0xFC,0x80,0x03,0xC6,
0x00,0x30,0x00,0x70,0x80,0x02,0x30,0x78,0x00,0x18,0x00,0x80,0x04,0x18,0x70,0xC0,
0xC0,0xC6,0xCC,0xF8,0xCC,0xC6,0x00,0x70,0x80,0x04,0x30,0x78,0x80,0x02,0x00,0xFC,
0x80,0x03,0xD6,0x80,0x02,0x00,0xDC,0xE6,0x80,0x02,0xC6,0x80,0x02,0x00,0x7C,0x80,
0x02,0xC6,0x7C,0x80,0x02,0x00,0xFC,0x80,0x02,0xC6,0xFC,0xC0,0x00,0x00,0x7E,0x80,
0x02,0xC6,0x7E,0x06,0x00,0x00,0xDC,0xE6,0x80,0x02,0xC0,0x80,0x02,0x00,0x7E,0xC0,
0x7C,0x06,0xFC,0x00,0x30,0x30,0x7C,0x80,0x02,0x30,0x1C,0x80,0x02,0x00,0x80,0x03,
0xC6,0x7C,0x80,0x02,0x00,0x80,0x02,0xC6,0x6C,0x38,0x80,0x02,0x00,0xC6,0xD6,0xFE,
0xEE,0xC6,0x80,0x02,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x80,0x02,0x00,0x80,0x02,0xC6,
0x7E,0x06,0x7C,0x00,0x00,0xFC,0x18,0x30,0x60,0xFC,0x80,0x29,0x00,0x7C,0x80,0x02,
0xC0,0x7C,0x10,0x30,0x00,0x28,0x00,0x80,0x02,0xC6,0x7C,0x00,0x00,0x06,0x7C,0xC6,
0xFE,0xC0,0x7E,0x80,0x11,0x00,0xC0,0x7C,0x06,0x7E,0xC6,0xFE,0x80,0x0A,0x00,0x7C,
0xC0,0xC0,0x7C,0x10,0x30,0x80,0x10,0x00,0xC0,0x7C,0xC6,0xFE,0xC0,0x7E,0x80,0x11,
0x00,0x30,0x18,0x00,0x38,0x18,0x3C,0x80,0x39,0x00,0xC0,0x60,0x7C,0xC6,0xC6,0x7C,
0x80,0x48,0x00,0x0C,0x1E,0x3E,0x5C,0x68,0x70,0x80,0x02,0x00,0x06,0x7C,0x06,0x7E,
0xC6,0xFE,0x00,0x00,0x0C,0x18,0x00,0x38,0x18,0x3C,0x00,0x00,0x06,0x0C,0x7C,0xC6,
0xC6,0x7C,0x00,0x00,0x06,0x0C,0x80,0x02,0xC6,0x7C,0x00,0x00,0xFC,0x00,0xFC,0x80,
0x02,0xC6,0x00,0xFE,0x00,0xE6,0xF6,0xDE,0xCE,0xC6,0x00,0x00,0x38,0x18,0x38,0x00,
0x38,0x80,0x02,0x00,0x38,0x28,0x38,0x00,0x38,0x80,0x03,0x00,0x30,0x00,0x30,0x60,
0xCC,0x78,0x80,0x9F,0x00,0x7F,0xF8,0x80,0x02,0xF7,0xF8,0x7F,0x00,0xFF,0xDD,0x4D,
0x55,0x59,0xDD,0xFF,0x00,0xE0,0x80,0x04,0xF0,0xE0,0x80,0xE8,0x00,0x7F,0xE3,0x80,
0x02,0xDD,0xE3,0x7F,0x00,0xFF,0x08,0x7B,0x18,0x7B,0x7B,0xFF,0x00,0xE0,0x70,0x80,
0x03,0xF0,0xE0,0x00,0x80,0xBF,0xFF,0x80,0x3F,0x00,0x80,0xFF};


// Project: mvac7_tileset_GUI_05
// tileset color - type:G1
// RLE WB compressed - Original size= 32 - Compress size= 19
const char SC1_TSET_COLOR[]={
0x74,0x24,0xE4,0xE4,0x80,0x11,0xF4,0x04,0x34,0x80,0x02,0x04,0x94,0x80,0x02,0x48,
0x04,0x80,0xFF};



// global variable definition --------------------------------------------------

char VALUE;

char SPRBUFFER[72];  //20*4 =72B


boolean Row6pressed;
boolean Row7pressed;

uint firstPATaddr;

uint songNames[2];
uint songAuthors[2];
uint songPT3Data[2];

char _loop;


// Functions -------------------------------------------------------------------


// Routine for Hook TIMI (FD9Fh)
void my_isr0(void) __interrupt 
{
	//DI;
	//READ_VDP_STATUS;     <<---- It is not necessary as the ISR in the BIOS does.

__asm push  AF __endasm;
  
    PlayAY();

__asm  
  ;vuelca a VRAM buffer atributos sprites
  ld   HL,#_SPRBUFFER
  ld   DE,#BASE13  
  ld   BC,#20*4
  call 0x005C  
__endasm;

__asm pop   AF __endasm;       

  //EI;
}




//
void main(void)
{
  char keyPressed;
    
  uint conta = 0;
  uint songStep;
  
  Row6pressed=false;
  Row7pressed=false;
  
  songNames[0] = (unsigned int) SONG00_name;
  songNames[1] = (unsigned int) SONG01_name;
  songAuthors[0] = (unsigned int) SONG00_author;
  songAuthors[1] = (unsigned int) SONG01_author;  
  songPT3Data[0] = (unsigned int) SONG00;
  songPT3Data[1] = (unsigned int) SONG01;
  
   
  COLOR(WHITE,DARK_BLUE,LIGHT_BLUE);
          
  WIDTH(32);
  SCREEN1();    
  SetSpritesSize(1);
  
  unRLEWBtoVRAM((uint) SC1_TSET, BASE7);
  unRLEWBtoVRAM((uint) SC1_TSET_COLOR, BASE6);   
  
  LOCATE(0,0);
  PRINT(text01);
  PRINT("\n");
  PRINT(text02);
  
  // Initialize the Player
  NoteTable = (unsigned int) NT;
  Player_Init();
  //
  
    
  _loop = Loop_OFF;
  
            
  LOCATE(0,3);
  PRINT("F1/F2  Play a song\n"); 
  //PRINT("RETURN Play the song\n");
  PRINT("STOP   Pause/Resume playback\n");
  PRINT("TAB    Change Loop mode\n");
  
  LOCATE(0,23);
  PRINT("PLAY:     LOOP:     END:");
    
  SetSPRITES();
  
  install_isr(my_isr0);
  
  while(1)
  {
    HALT;
      
    
    if ((PT3state & Bit1))
    {
        songStep=PT3_CrPsPtr - firstPATaddr;
        LOCATE(7,13);
        PrintFNumber(songStep,32,3);
        //LOCATE(25,13);
        //PrintFNumber(PEEKW(PT3_LPosPtr),32,5);
    }

    ShowVumeter(0,AYREGS[AR_AmplA]);
    ShowVumeter(1,AYREGS[AR_AmplB]);
    ShowVumeter(2,AYREGS[AR_AmplC]);    

    
    // Keyboard row 6
    keyPressed = GetKeyMatrix(6);  
    if (keyPressed!=0xFF)  //pressure control of the keys
    {
      if(Row6pressed==false)
      {
        if (!(keyPressed & Bit5)){Row6pressed=true;PlaySong(0);} //F1 Key
        if (!(keyPressed & Bit6)){Row6pressed=true;PlaySong(1);} //F2 Key
        //if (!(keyPressed & Bit7)){keyB6pressStatus=true;PlaySong(3);} //F3 Key        
      }      
    }else{
      Row6pressed=false;        
    }   
    
    
    // Keyboard row 7
    keyPressed = GetKeyMatrix(7);
    if (keyPressed!=0xFF)
    {
      if(Row7pressed==false)
      {
        //if (!(keyPressed&Bit0)) {Row7pressed=true;}; // [F4]
        //if (!(keyPressed&Bit1)) {Row7pressed=true;}; // [F5]
        //if (!(keyPressed&Bit2)) {Row7pressed=true;}; // [ESC]
        if (!(keyPressed&Bit3)) {Row7pressed=true;SwapLoop();}; // [TAB]
        if (!(keyPressed&Bit4)) {Row7pressed=true;Pause();}; // [STOP]
        //if (!(keyPressed&Bit5)) {Row7pressed=true;}; // [BS]
        //if (!(keyPressed&Bit6)) {Row7pressed=true;}; // [SELECT]
        //if (!(keyPressed&Bit7)) {Row7pressed=true;PlaySong(0);}; // [RETURN]
      }      
    }else Row7pressed=false;
    
    
    Player_Decode();  //Process the next step in the song sequence
    
    ShowPlayback();
    ShowLoop();
    ShowENDsong();
    
  }

/*  
  uninstall_isr();
  
  CLS();
  PRINT("END");
  WAIT(30*5);
*/  
}



void Pause()
{
    
   if ((PT3state & Bit1)) Player_Pause();
   else Player_Resume();
   
}


void SwapLoop()
{
  _loop = !_loop;
  
  Player_Loop(_loop);
  //ShowLoop();
}



void PlaySong(char songNumber)
{
  DI;
   
  //PT3Init((unsigned int) SONG00 - 100,0); // Subtract 100 if you delete the header of the PT3 file.    
  Player_InitSong(songPT3Data[songNumber], _loop);  // (unsigned int) Song data address ; (char) Loop - 0=off ; 1=on
  
  firstPATaddr = PT3_CrPsPtr;
  
  LOCATE(0,9);  
  PRINT("Song  :   ");
  LOCATE(7,9);
  PrintFNumber(songNumber+1,32,1);
  
  LOCATE(0,10);
  PRINT("Name  :                         ");
  LOCATE(7,10);
  PrintF((char*) songNames[songNumber],25);
  
  LOCATE(0,11);
  PRINT("Author:                         ");
  LOCATE(7,11);
  PrintF((char*) songAuthors[songNumber],25);
  
  LOCATE(0,13);    
  PRINT("Pos.  :    ");
  
  //PRINT("\nTempo : ");
  //PrintFNumber(TEMPO,32,2);
  
  //ShowLoop();
  EI;
}



void PrintF(char* text, char length)
{ 
  while(*(text) && length-->0)  bchput(*(text++));
}




void ShowPlayback()
{   
  if ((PT3state & Bit1)) ShowState(BASE5+741,true);  //741 = 23*32 + 5
  else ShowState(BASE5+741,false);
}



void ShowLoop()
{   
  if ((PT3state & Bit4)) ShowState(BASE5+751,true);  //751 = 23*32 + 15
  else ShowState(BASE5+751,false);
}



void ShowENDsong()
{   
  if ((Player_IsEnd()==true)) ShowState(BASE5+760,true);  //760 = 23*32 + 24
  else ShowState(BASE5+760,false);
}



/* =============================================================================
 SetSpritesSize
 Description: Set size type for the sprites.
 Input:       [char] size: 0=8x8; 1=16x16
 Output:      -
============================================================================= */ 
void SetSpritesSize(char size) __naked
{
size;
__asm
  push IX
  ld   IX,#0
  add  IX,SP
  
  ld   HL,#RG0SAV+1 ; --- read vdp(1) from mem
  ld   B,(HL)

  ld   A,4(ix)    
  cp   #1
  jr   NZ,size8
  
  set  1,B ; 16x16
  jr   setSize
  
size8:
  res  1,B  ; 8x8    

setSize:  
  ld   C,#0x01
  call writeVDP
  
  pop  IX
  ret
  
  
writeVDP:

  ld   IY,#RG0SAV
  ld   E,C
  ld   D,#0
  add  IY,DE
  ld   (IY),B ;save copy of vdp value in system var
  
  ld   A,B
  di
  out	 (#VDPSTATUS),A
  ld   A,C
  or   #0x80            ;add 128 to VDP reg value
  out	 (#VDPSTATUS),A
  ei
  ret

__endasm;
}



/* =============================================================================
 VPOKE
 Description: Writes a byte to the video RAM. 
 Input      : [unsigned int] VRAM address
              [char] value
 Output     : - 
============================================================================= */
void VPOKE(unsigned int vaddr, char value) __naked
{
vaddr;
value;
__asm
  push IX
  ld   IX,#0
  add  IX,SP
  
  ld   L,4(IX)
  ld   H,5(IX)
   
  ld   A,6(IX)
  
  call WRTVRM
  
  pop  IX
  ret
__endasm;
}



/*char VPEEK(uint address) __naked
{
address;
__asm
  push IX
  ld   IX,#0
  add  IX,SP
    
  ld   L,4(IX)
  ld   H,5(IX) 
   
  call RDVRM
  
  ld   L,A
  pop  IX
  ret
__endasm;
}*/



/* =============================================================================
   WAIT
   Generates a pause in the execution of n interruptions.
   PAL: 50=1second. ; NTSC: 60=1second.
   Input    : [unsigned int] cicles 
   Output   : -
============================================================================= */ 
void WAIT(uint cicles)
{
  uint i;
  for(i=0;i<cicles;i++) HALT;
  return;
}



void ShowState(uint vaddr, boolean state)
{
    char tile;
    if (state==true) tile=189;
    else tile=221;
    VPOKE(vaddr++,tile++);
    VPOKE(vaddr++,tile++);
    VPOKE(vaddr,tile);
}


void ShowVumeter(char channel, char value)
{
channel;value;
__asm

  push IX
  ld   IX,#0
  add  IX,SP
    
  ld   C,4(IX)
  ld   A,5(IX)


;C = num channel
;A = value  
;showVumeter:

	ld   (_VALUE),A

	SLA  C
	SLA  C

	ld	 B,#0
L00107:
	ld	a,c
	ld	l,a
	rla
	sbc	a, a
	ld	h,a
	add	hl,hl
	add	hl,hl

  ld   DE,#_SPRBUFFER
  ADD  HL,DE
  ex   DE,HL
  
	inc	 DE
	inc	 DE

	ld   A,(_VALUE)
	cp	 #0
	jr	 NZ,L00102
	xor  A
	ld	 (DE),A
	jr   L00105
  
L00102:                       
  ld   A,(_VALUE)
	cp   #4
	jr	 C,L00104
	ld	 A,#16
	ld	 (DE),A

	ld    A,(_VALUE)
  sub   #4
	ld   (_VALUE),A
	jr	 L00105
L00104:
  ld   A,(_VALUE)
	add	 a,a
	add	 a,a
	ld	(DE),A
	xor  A
	ld   (_VALUE),A
L00105:
	inc	 C
	inc	 B
	ld	 A,B
  cp   #4
	jr	C,L00107
  

  pop  IX
;  ret
  
__endasm;
}



void SetSPRITES() __naked
{
__asm


  ld   HL,#SPRITE_DATA
  ld   DE,#BASE14  
  ld   BC,#32*5
  call 0x005C

  ld   DE,#_SPRBUFFER
  ld   HL,#VUMETER
  ld   BC,#64
  ldir
  
  ret
  

SPRITE_DATA:
; 0-vum0
.db 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
.db 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
; 1-vum1
.db 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x7F,0x7F,0x00
.db 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0xFE,0xFE,0x00
; 2-vum2
.db 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x7F,0x7F,0x00,0x7F,0x7F,0x7F,0x00
.db 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0xFE,0xFE,0x00,0xFE,0xFE,0xFE,0x00
; 3-vum3
.db 0x00,0x00,0x00,0x00,0x7F,0x7F,0x7F,0x00,0x7F,0x7F,0x7F,0x00,0x7F,0x7F,0x7F,0x00
.db 0x00,0x00,0x00,0x00,0xFE,0xFE,0xFE,0x00,0xFE,0xFE,0xFE,0x00,0xFE,0xFE,0xFE,0x00
; 4-vum4
.db 0x7F,0x7F,0x7F,0x00,0x7F,0x7F,0x7F,0x00,0x7F,0x7F,0x7F,0x00,0x7F,0x7F,0x7F,0x00
.db 0xFE,0xFE,0xFE,0x00,0xFE,0xFE,0xFE,0x00,0xFE,0xFE,0xFE,0x00,0xFE,0xFE,0xFE,0x00



;SPRITE ATRIBUTE DATAS #########################################################
; for adjust colors, changue the last valor in line


;Y,X,SPR,COLOR
VUMETER:
.db 167,8,0,2
.db 151,8,0,2
.db 135,8,0,10
.db 119,8,0,8

.db 167,24,0,2
.db 151,24,0,2
.db 135,24,0,10             
.db 119,24,0,8 

.db 167,40,0,2
.db 151,40,0,2
.db 135,40,0,10
.db 119,40,0,8
             
.db 167,56,0,2
.db 151,56,0,2
.db 135,56,0,10
.db 119,56,0,8
;END SPRITE ATRIBUTE DATAS #####################################################
__endasm;
}